<html>
    <head>
        <title> Save the ship! Ditch the reactor! </title>
        <script type="text/javascript">
(function(scope) {
    "use strict";
    var empty = " ";
    var wall = "wall";
    var core = "core";

    var crane_state_ceiling = "ceiling";
    var crane_state_placing = "placing";
    var crane_state_rising = "rising";

    var max_heat = 10;

    var game_state_gameover = "gameover";
    var game_state_crane = "crane";
    var game_state = game_state_crane;
    var level = [
        [wall, wall , wall , wall , wall , wall , wall , wall , wall],
        [wall, empty, empty, empty, empty, empty, empty, empty, wall],   
        [wall, empty, empty, empty, empty, empty, empty, empty, wall],   
        [wall, empty, empty, empty, empty, empty, empty, empty, wall],   
        [wall, empty, wall , empty, wall , empty, wall , empty, wall],   
        [wall, wall , wall , wall , wall , wall , wall , wall , wall],
    ];
    
    var core = {
        x : 1,
        y : 4,
        heat : 0
    }

    var crane = {
        x : 1,
        y : 1,
        held_item : undefined,
        state : crane_state_ceiling,
        last_animation_tick : Date.now()
    };

    var keysDown = {};

    function draw_level() {
        var canvas = document.getElementById('game_screen');
        for (var y = 0; y < level.length; y++) {
            for (var x = 0; x < level[y].length; x++) {
                var tile = level[y][x];
                var context = canvas.getContext('2d');
                if (tile === wall) {
                    context.fillStyle = "rgb(127, 127, 255)";
                } else if (tile === empty) {
                    context.fillStyle = "rgb(0, 0, 0)";
                } else {
                    context.fillStyle = "rgb(255, 0, 0)";
                }
                context.fillRect(50 * x, 50 * y, 50, 50);
            }
        }
    }

    function draw_crane() {
        var canvas = document.getElementById('game_screen');
        var x = crane.x * 50;
        var y = crane.y * 50;
        
        var context = canvas.getContext('2d');
        context.fillStyle="rgb(127,127,127)";
        context.beginPath();
        context.moveTo(x + 20, y);
        context.lineTo(x, y+50);
        context.lineTo(x+50, y+50);
        context.lineTo(x+40, y+40);
        context.lineTo(x+15, y+40);
        context.lineTo(x+30, y);
        context.fill();
    }

    function draw_reactor() {
        var canvas = document.getElementById('game_screen');
        var x = core.x * 50;
        var y = core.y * 50;

        var context = canvas.getContext('2d');
        context.fillStyle = "rgb(200, 127, 127)";
        context.beginPath();
        context.moveTo(x, y);
        context.lineTo(x+50, y);
        context.lineTo(x+40, y+10);
        context.lineTo(x+10, y+10);
        context.lineTo(x, y);
        context.fill();

        context.beginPath();
        context.moveTo(x, y+50);
        context.lineTo(x+50, y+50);
        context.lineTo(x+40, y+40);
        context.lineTo(x+10, y+40);
        context.lineTo(x, y+50);
        context.fill();

        context.fillStyle = "rgb(0, 0, 255)";
        context.beginPath();
        context.moveTo(x+25, y+10);
        context.lineTo(x+10, y+25);
        context.lineTo(x+25, y+40);
        context.lineTo(x+40, y+25);
        context.lineTo(x+25, y+10);
        context.fill();
    }

    function draw_reactor_status() {
        var canvas = document.getElementById('game_screen');
        var context = canvas.getContext('2d');
        context.fillStyle = "rgb(255, 255, 255)";
        context.fillRect(10, 300, 450, 100);
        context.fillStyle = "rgb(0, 0, 0)";
        context.font = "20pt Arial";
        context.fillText("Meltdown -" + (max_heat - core.heat)+ "s", 10, 350);
    }

    scope.addEventListener("keydown", function(e) {
        keysDown[e.keyCode] = true;
    }, false);

    scope.addEventListener("keyup", function(e) {
        delete keysDown[e.keyCode];
    }, false);

    var key_left = 37;
    var key_up = 38;
    var key_right = 39;
    var key_down = 40;

    scope.update = function() {
        if (game_state == game_state_crane) {
            update_in_crane_state();
        } else if (game_state == game_state_gameover) {
            update_in_gameover_state();
        }
    }

    function update_in_gameover_state() {
        var canvas = document.getElementById('game_screen');
        var context = canvas.getContext('2d');
        context.fillStyle = "rgb(255, 0, 0)";
        context.fillRect(0, 0, canvas.width, canvas.height);
        context.fillStyle = "rgb(0, 0, 0)";
        context.fontStyle = "30pt Arial";
        context.fillText("BOOM", 180, 200);
    }

    function update_in_crane_state() {
        if (crane.state == crane_state_placing) {
            var now = Date.now();
            if (1000 < now - crane.last_animation_tick) {
                crane.y += 1;
                if (crane.held_item != undefined) {
                    crane.held_item.y += 1;
                }
                crane.last_animation_tick = now;

                var y_offset_to_check;
                if (crane.held_item == undefined) {
                    var check_y = crane.y + 1;
                    var check_x = crane.x;
                    if (check_x == core.x && check_y == core.y) {
                        crane.held_item = core;
                        crane.state = crane_state_rising;
                    } else if (level[check_y][check_y] == wall) {
                        crane.state = crane_state_rising;
                    }
                } else {
                    if (level[crane.y + 2][crane.x] == wall) {
                        crane.held_item = undefined;
                        crane.state = crane_state_rising;
                    }
                }
            }        
        }

        if (crane.state == crane_state_rising) {
            var now = Date.now();
            if (1000 < now - crane.last_animation_tick) {
                crane.y -= 1;
                if (crane.held_item != undefined) {
                    crane.held_item.y -= 1;
                }
                crane.last_animation_tick = now;
                if (crane.y == 1) {
                    crane.state = crane_state_ceiling;
                }
            }        
        }

        if (key_down in keysDown && crane.state == crane_state_ceiling) {
            crane.state = crane_state_placing;
            core.heat++;
            delete keysDown[key_down];
        }

        if (key_left in keysDown) {
            if (crane.state == crane_state_ceiling) {
                if (2 <= crane.x) {
                    crane.x -= 1;
                    core.heat++;
                    if (crane.held_item != undefined) {
                        crane.held_item.x -= 1;
                    }
                }
                delete keysDown[key_left];
            }
        }

        if (key_right in keysDown) {
            if (crane.state == crane_state_ceiling) {
                if (crane.x <= 6) {
                    crane.x += 1;
                    core.heat++;
                    if (crane.held_item != undefined) {
                        crane.held_item.x += 1;
                    }
                }
                delete keysDown[key_right];
            }
        }
        draw_level();
        draw_crane();
        draw_reactor();
        draw_reactor_status();

        if (core.heat == max_heat) {
            game_state = game_state_gameover;
        }
    }

    window.setInterval(update, 1);}(window))
         </script>
        <style type="text/css">
            canvas { border:1px solid black; }
        </style>
    </head>
    <body>
        <canvas width="450" height="400" id="game_screen"> </canvas>
    </body>
</html>
